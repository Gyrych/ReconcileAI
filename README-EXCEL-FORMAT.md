# Excel文件格式说明

## 必需格式要求

为了确保系统能够正确读取和处理你的Excel文件，请确保文件符合以下格式要求：

### 1. 基本要求
- 文件类型：`.xlsx`、`.xls`、`.xlsm` 或 `.csv`
- 文件大小：不超过10MB
- 编码：UTF-8

### 2. 必需的列

Excel文件必须包含以下两列（列名可以是中文或英文）：

| 中文列名 | 英文列名 | 说明 |
|---------|---------|------|
| 名称 | name | 财务条目的名称 |
| 金额 | amount | 财务条目的金额（数值类型） |

### 3. 列名示例

#### 中文列名：
```excel
名称        金额
工资薪酬    5000.00
办公用品    150.50
房租        2000.00
```

#### 英文列名：
```excel
name        amount
Salary      5000.00
Supplies    150.50
Rent        2000.00
```

#### 混合列名：
```excel
项目        金额
工资        5000.00
办公费      150.50
```

### 4. 金额格式要求

- 必须是数字格式
- 支持小数点（保留两位小数）
- 支持千分位分隔符（逗号）
- 不支持货币符号（¥、$等）

#### 正确示例：
- `5000.00`
- `1,500.50`
- `2000`

#### 错误示例：
- `¥5,000.00`（包含货币符号）
- `5千元`（包含中文单位）
- `五千元`（非数字格式）

### 5. 完整文件示例

创建一个名为 `标准表.xlsx` 的文件：

| 名称 | 金额 |
|------|------|
| 员工工资 | 50000.00 |
| 办公用品采购 | 1500.00 |
| 房租 | 8000.00 |
| 水电费 | 1200.00 |
| 差旅费 | 3000.00 |

创建一个名为 `待核对表.xlsx` 的文件：

| 名称 | 金额 |
|------|------|
| 员工薪资 | 50000.00 |
| 办公用品 | 1500.00 |
| 房屋租赁 | 8000.00 |
| 水电费 | 1200.00 |
| 出差费用 | 3000.00 |

### 6. 注意事项

1. **标题行必须存在**：第一行必须是列标题
2. **数据从第二行开始**：实际数据从第二行开始
3. **不要有合并单元格**：避免合并单元格，保持简单表格格式
4. **不要有空行**：连续的数据行之间不要有空行
5. **列名不区分大小写**：系统会自动识别各种变体的列名
6. **支持多个工作表**：但系统只会读取第一个工作表

### 7. 故障排除

如果文件上传后仍然无法进入下一步，请检查：

1. 文件是否包含必需的"名称"和"金额"列
2. 列名是否正确（参考上面的示例）
3. 金额是否为数字格式
4. 文件大小是否超过10MB限制
5. API密钥是否已正确设置并验证通过

### 9. 自动标题检测与AI合并说明

1. 系统会尝试自动检测标题行位置：在文件顶部的前5行中，系统会选择第一个包含至少两个非空单元格并且含有非纯数字文本的行作为标题行，这样可以自动跳过像 `金额单位：元` 这样的说明行。
2. 如果你提供了有效的 AI（DeepSeek）API Key，系统会在必要时使用 AI 来智能识别哪些列应该组合为名称列，并可对每一行进行语义化汇总生成简洁的 `名称` 字段（例如从 `收款人全称`、`用途`、`单位信息` 等列汇总得到）。
3. 若 AI 未启用或返回异常，系统将回退为本地合并策略：按候选列优先级拼接非空文本并进行简单清洗。
4. 请确保标题行中没有隐藏的零宽字符或BOM（如遇匹配问题，请在文本编辑器中检查并删除不可见字符）。

### 行级上下文（contextText）说明

系统现在会为每一行生成一个 `contextText` 字段，该字段由该行除金额外的所有可读文本列合并、去重和清洗得到，用于在 AI 分类阶段提供更完整的语义上下文。例如：`用途 · 单位信息 · 收款人全称`。如果提供了 AI Key，分类模型会优先参考 `contextText` 以提高分类准确性。若你希望禁用该行为，请在上传前移除不必要的列或联系维护者更改配置。

以上机制旨在提高对真实业务表格的容错能力，但如果上传文件包含不规则的说明行或复杂格式，建议在上传前将标题行调整为文件的第一行以获得最佳兼容性。

### 8. 测试建议

建议先使用少量数据（3-5行）进行测试，确保格式正确后再使用完整数据。
